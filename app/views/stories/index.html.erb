<% form_url = @advanced ? search_results_stories_path : stories_path %>
<% form_method = @advanced ? :post : :get %>
<div class='news_group'>
  <div class='news_block'>
    <h2>
      <span><%= t('search.page.title', :query => "<em>'#{ truncate( @query, 20 ) }'</em>" ) -%></span>
      <span class='links'><%= render_filter_links( @stories.facets, form_url, form_method ) %></span>
      <span class='links'><%= render_search_preference_form( :sort_criteria, :subscription_type, :form_url => form_url, :form_method => form_method ) %></span>
      <span class='links'><%= render :partial => 'topic_form' %></span>
    </h2>
    <% unless display_only_story_search_results? %>
      <% if @authors.any? %>
        <h4>Authors</h4>
        <div class='cluster'>
        <% @authors.each_with_index do |author, index| %>
          <%= link_to author.name, author_path( author ) -%><%= ', ' unless index == @authors.size - 1  %>
        <% end %>
        </div>
      <% end %>
      <% if @sources.any? %>
        <h4>Sources</h4>
        <div class='cluster'>
          <% @sources.each_with_index do |source, index| %>
            <%= link_to source.name, source_path( source ) -%><%= ', ' unless index == @sources.size - 1 %>
          <% end %>
        </div>
      <% end %>
      <% if @authors.any? || @sources.any? %>
        <h4>Stories</h4>
      <% end %>
    <% end %>
    <% @stories.each do |story| %>
      <div class='cluster'>
        <% if story.cluster && story.cluster.stories.any? %>
          <%= render_cluster_preview( story.cluster, story ) %>
        <% else %>
          <%= render_story_search_preview( story ) %>
        <% end %>
      </div>
    <% end %>
    <% if @stories.empty? %>
      <em><%= t( 'stories.not.found' ) %></em>
    <% end %>
  </div>
</div>
<%= render_search_pagination( @stories, :form_url => form_url, :form_method => form_method ) %>